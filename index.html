<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Menú clínico | Pulmón & Sueño</title>
<style>
  :root{--bg:#0f172a;--panel:#111827;--card:#1f2937;--text:#e5e7eb;--muted:#94a3b8;--accent:#22d3ee}
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .app{display:grid;grid-template-columns:300px 1fr;grid-template-rows:auto 1fr;min-height:100vh}
  header{grid-column:1/-1;padding:14px 18px;border-bottom:1px solid #243244;background:#0b1220cc;backdrop-filter:blur(6px);position:sticky;top:0;z-index:3}
  header h1{margin:0;font-size:18px;font-weight:600;letter-spacing:.2px}
  .sidebar{background:var(--panel);border-right:1px solid #243244;display:flex;flex-direction:column;gap:12px;padding:14px;overflow:auto}
  .search{display:flex;gap:8px}
  .search input{flex:1;padding:10px 12px;border:1px solid #324055;border-radius:10px;background:#0f1a2b;color:var(--text);outline:none}
  .section{border:1px solid #2a364a;border-radius:12px;background:linear-gradient(180deg,#132035,#0f1a2b);margin-top:4px}
  .sec-head{display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;user-select:none}
  .sec-head span{font-weight:600} .chev{margin-left:auto;transition:transform .15s}
  .open .chev{transform:rotate(90deg)} .sec-body{display:none;padding:6px 10px 10px}
  .open .sec-body{display:block}
  .label{color:var(--muted);font-size:12px;margin:8px 0 4px}
  .subitem{display:block;padding:9px 10px;margin:6px 0;border:1px solid #2a364a;border-radius:10px;background:#122036;color:var(--text);text-decoration:none;transition:transform .06s,border .12s}
  .subitem:hover{transform:translateY(-1px);border-color:#3a4d68}
  .active{border-color:var(--accent)!important;box-shadow:0 0 0 1px #22d3ee33 inset}
  .content{position:relative} .frame-wrap{position:sticky;top:64px;height:calc(100vh - 64px)}
  iframe{width:100%;height:100%;border:0;background:#0b1220}
  @media (max-width: 900px){.app{grid-template-columns:1fr;grid-template-rows:auto auto 1fr}.frame-wrap{position:static;height:70vh}}
</style>
</head>
<body>
  <div class="app">
    <header><h1 id="title">Menú clínico | Pulmón & Sueño</h1></header>

    <aside class="sidebar">
      <div class="search">
        <input id="q" type="search" placeholder="Filtra (p. ej. 6mwt, espirometría, EPOC, asma, sueño)..." />
      </div>
      <div id="nav"></div>
    </aside>

    <main class="content">
      <div class="frame-wrap">
        <iframe id="viewer" title="Visor"></iframe>
      </div>
    </main>
  </div>

<script>
  const LS_KEY = "hub:last";
  const viewer = document.getElementById('viewer');
  const q = document.getElementById('q');
  const nav = document.getElementById('nav');

  const $el = (tag, cls, txt) => {
    const e = document.createElement(tag);
    if (cls) e.className = cls;
    if (txt) e.textContent = txt;
    return e;
  };

  fetch('manifest.json')
    .then(r => r.json())
    .then(data => {
      if (data.title) document.getElementById('title').textContent = data.title;
      buildMenu(data.sections || []);
      applyFilter();
      loadFromHashOrLast();
      window.addEventListener('hashchange', loadFromHashOrLast);
      q.addEventListener('input', applyFilter);
    })
    .catch(err => {
      console.error('No se pudo cargar manifest.json', err);
      nav.textContent = 'Error cargando el menú.';
    });

  function buildMenu(sections){
    nav.innerHTML = '';
    sections.forEach(sec => {
      const section = $el('section','section open');
      section.dataset.tags = (sec.tags||'');
      const head = $el('div','sec-head');
      head.append($el('span','',sec.name||'Sección'));
      const chev = $el('div','chev','▶'); head.append(chev);
      head.addEventListener('click',()=>section.classList.toggle('open'));
      section.append(head);

      const body = $el('div','sec-body');
      (sec.groups||[]).forEach(g=>{
        if (g.label) body.append($el('div','label',g.label));
        (g.items||[]).forEach(item=>{
          const a = $el('a','subitem',item.title||item.href);
          a.href = item.href; a.dataset.tags = (item.tags||'');
          a.addEventListener('click',e=>{e.preventDefault(); load(a.getAttribute('href'));});
          body.append(a);
        });
      });
      section.append(body);
      nav.append(section);
    });
  }

  function load(href){
    document.querySelectorAll('.subitem').forEach(a=>a.classList.toggle('active', a.getAttribute('href')===href));
    viewer.src = href;
    localStorage.setItem(LS_KEY, href);
    location.hash = encodeURIComponent(href);
  }

  function loadFromHashOrLast(){
    const hash = decodeURIComponent(location.hash.replace(/^#/, ""));
    const target = hash || localStorage.getItem(LS_KEY) || "";
    if (target) load(target);
  }

  function applyFilter(){
    const term = (q.value||"").toLowerCase().trim();
    document.querySelectorAll('.section').forEach(sec=>{
      const secTags = (sec.dataset.tags||"").toLowerCase();
      let anyItemVisible = false;
      sec.querySelectorAll('.subitem').forEach(a=>{
        const hay = !term || (a.textContent.toLowerCase().includes(term) || (a.dataset.tags||"").toLowerCase().includes(term));
        a.style.display = hay ? "" : "none";
        anyItemVisible = anyItemVisible || hay;
      });
      const showSection = !term || anyItemVisible || secTags.includes(term);
      sec.style.display = showSection ? "" : "none";
      if (term && anyItemVisible) sec.classList.add('open');
    });
  }
</script>
</body>
</html>
